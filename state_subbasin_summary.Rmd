---
output: 
  html_document:
    mode: selfcontained
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
    fig_width: 12
  word_document: 
    fig_caption: yes
    reference_docx: N:/Status_and_Trend_Reports/Report_Files/Subbasin_Template.docx
    toc: yes 
    fig_width: 12
    fig_height: 6
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      eval = TRUE,
                      fig.keep = 'all',
                      fig.path = paste0(out_dir, "/Figures/"),
                      fig.width = 12, 
                      fig.height = 6
                      )

options(kableExtra.auto_format = F)

```


#### `r paste(subbasin_name)`

##### Water Quality Limited Stream Segments 

```{r wql_streams, include= TRUE, results= 'asis'}

wql_sub <- wql_data[grep(i, wql_data$HUC_4TH_CO), c('STREAM_LAK', 'LLID_STREA', 
                                                    'MILES', 'POLLUTANT', 'SEASON', 
                                                    'ASSESSME_1', 'CRITERIA', 
                                                    'LISTING_ST', 'TMDL_INFO')] %>% 
  plyr::rename(c('STREAM_LAK' = 'Waterbody',
                 'LLID_STREA' = 'LLID',
                 'ASSESSME_1' = 'Year Assessed',
                 'LISTING_ST' = 'Listing Status',
                 'POLLUTANT' = 'Pollutant'))
if(nrow(wql_sub) > 0){
  
wql_sub <- wql_sub[grep("Cat 5|Cat 4A", wql_sub$`Listing Status`, ignore.case = TRUE), 
                   c('Waterbody', 'MILES', 'Pollutant', 'SEASON', 'Year Assessed', 'CRITERIA', 'Listing Status')] %>% 
  dplyr::arrange(Waterbody)

wql_sub$`Listing Status` <- gsub("Cat 4A: Water quality limited, TMDL approved", "Cat 4A", wql_sub$`Listing Status`)
wql_sub[grep("Cat 5", wql_sub$`Listing Status`, ignore.case = TRUE), "Listing Status"] <- "Cat 5"

wql_sub <- wql_sub %>% group_by(Pollutant) %>% summarise('Segments Impaired' = n())

knitr::kable(wql_sub, format = table_format, padding = 0, digits = 1, row.names = FALSE,
             caption = tbls(name = paste0(subbasin_name, "_wql"),
                            caption = paste0("Number of water quality impaired stream segments in the ", 
                                             subbasin_name,
                                             " Subbasin for the parameters assessed in this report. Impairments are summarized from the final 2012 303(d) integrated report."))) %>% 
  table_style()

} else {cat("There are no water quality impaired Category 4A or Category 5 stream segments in this subbasin.")}

```

##### Status

There are `r length(unique(par_sum_au$AU_ID))' assessment units within the `r subbasin_name` subbasin that were included in this report. `r tbls(name = paste0(subbasin_name, "_au_sum"), display="cite")` and `r figs(name = paste0(subbasin_name, "_au_sum_plot"), display="cite")` summarizes the number of attaining, not attaining, and unassessed assessment units by parameter.

```{r status-au-table-sum, include = TRUE, results = 'asis'}

au_sum <- par_sum_au %>% group_by(Char_Name) %>% 
  summarise(Attaining = sum(status_2015_2018 == "Attaining"),
            "Not Attaining" = sum(status_2015_2018 == "Not Attaining"),
            Unassessed = sum(status_2015_2018 == "Unassessed")) %>% 
  mutate(Char_Name = sapply(Char_Name, simpleCap, USE.NAMES = FALSE)) %>% 
  rename(Pollutant = Char_Name)

knitr::kable(au_sum, padding = 0, digits = 1, row.names = FALSE, format = table_format,
             caption = tbls(name = paste0(subbasin_name, "_au_sum"),
                            caption = paste0("Summary of assessment unit status within the ", subbasin_name, " Subbasin."))
             ) %>% 
  table_style()

```

```{r status-au-plot, include = TRUE, results = 'asis', fig.cap = cap_list, eval.after = 'fig.cap'}

cap_list <- list()

ggplot(reshape2::melt(au_sum, id.vars = "Pollutant", variable.name = "Status"))+
  geom_bar(aes(x = Pollutant, y = value, fill = Status), stat = "identity", position = "dodge")+
  xlab("Pollutant")+
  ylab("# of Assessment Units")+
  scale_fill_manual(values = c("Attaining" = "forestgreen", "Not Attaining" = "orange", "Unassessed" = "gray"))+
  theme_bw()+
  ggtitle("Assessment Unit Attainment Count", subtitle = "Summarized by Pollutant")

cap_list[[1]] <- figs(name = paste0(subbasin_name, "_au_sum_plot"), caption = paste0("Summary plot of assessment unit status within the ", subbasin_name, " Subbasin by parameter."))

```

Oregon DEQ groups assessment units into four types; streams, lakes, watershed units, or estuaries and bays. `r tbls(name = paste0(subbasin_name, "_au_type_sum"), display="cite")` summarizes of the number of attaining, not attaining, and unassessed assessment units by parameter and assessment unit type.

```{r status-au-table-type, include = TRUE, results = 'asis'}

au_sum_type <- par_sum_au %>% group_by(AU_Type, Char_Name) %>% 
  summarise(Attaining = sum(status_2015_2018 == "Attaining"),
            "Not Attaining" = sum(status_2015_2018 == "Not Attaining"),
            Unassessed = sum(status_2015_2018 == "Unassessed")) %>% 
  mutate(Char_Name = sapply(Char_Name, simpleCap, USE.NAMES = FALSE)) %>% 
  rename("AU Type" = AU_Type, Pollutant = Char_Name)

knitr::kable(au_sum_type, padding = 0, digits = 1, row.names = FALSE, format = table_format, 
             caption = tbls(name = paste0(subbasin_name, "_au_type_sum"),
                            caption = paste0(subbasin_name, " Subbasin status summary of assessment units by type."))) %>%
  table_style()
             
```

There are `r length(unique(par_sum$MLocID))` stations within the `r subbasin_name' subbasin that were included in this report.  `r tbls(name = paste0(subbasin_name, "_stn_sum"), display="cite")` and `r figs(name = paste0(subbasin_name, "_stn_sum_plot"), display="cite")` summarizes the number of attaining, not attaining, and unassessed stations by parameter.

```{r status-stn-table-sum, include = TRUE, results = 'asis'}

stn_sum <- par_sum %>% group_by(Pollutant) %>% 
  summarise(Attaining = sum(status_2015_2018 == "Attaining"),
            "Not Attaining" = sum(status_2015_2018 == "Not Attaining"),
            Unassessed = sum(status_2015_2018 == "Unassessed")) %>% 
  mutate(Pollutant = sapply(Pollutant, simpleCap, USE.NAMES = FALSE))

knitr::kable(stn_sum, padding = 0, digits = 1, row.names = FALSE, format = table_format,
             caption = tbls(name = paste0(subbasin_name, "_stn_sum"),
                            caption = paste0("Summary of the status of stations within the ", subbasin_name, " Subbasin."))
             ) %>%
  table_style()

```


```{r status-stn-plot, include = TRUE, results = 'asis', fig.cap = cap_list, eval.after = 'fig.cap'}

ggplot(reshape2::melt(stn_sum, id.vars = "Pollutant", variable.name = "Status"))+
  geom_bar(aes(x = Pollutant, y = value, fill = Status), stat = "identity", position = "dodge")+
  xlab("Pollutant")+
  ylab("# of Stations")+
  scale_fill_manual(values = c("Attaining" = "forestgreen", "Not Attaining" = "orange", "Unassessed" = "gray"))+
  theme_bw()+
  ggtitle("Station Attainment Count", subtitle = "Summarized by Pollutant")

cap_list[[2]] <- figs(name = paste0(subbasin_name, "_stn_sum_plot"),
                      caption = paste0("Summary plot of station status within the ", subbasin_name, " Subbasin by parameter."))

```

##### Trend

A summary of the trends within parameters is shown in `r tbls(name = paste0(subbasin_name, "_stn_trend_sum"), display="cite")`. Note that trend requires significantly more data than status and may result in many stations with insufficient data for trend analysis.

```{r trend-table, include = TRUE, results = 'asis'}

stn_sum <- par_sum %>% group_by(Pollutant) %>% 
  summarise(Improving = sum(trend == "Improving"),
            Degrading = sum(trend == "Degrading"),
            Steady = sum(trend == "Steady"),
            "No Significant Trend" = sum(trend == "No Significant Trend"),
            "Insufficient Data" = sum(trend == "Insufficient Data")) %>% 
  mutate(Pollutant = sapply(Pollutant, simpleCap, USE.NAMES = FALSE))

knitr::kable(stn_sum, padding = 0, digits = 1, row.names = FALSE, format = table_format,
             caption = tbls(name = paste0(subbasin_name, "_stn_trend_sum"),
                            caption = paste0("Subbasin Summary of trend results at stations across the ",subbasin_name, "."))
             ) %>% 
  table_style()

cat("\n\n")
```

